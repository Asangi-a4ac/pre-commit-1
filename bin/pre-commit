#!/usr/bin/env ruby

template = <<EOS
#!/usr/bin/env ruby

exit(system("%cmd%") ? 0 : 1)
EOS

if ARGV[0] != "install"
  puts "Usage: pre-commit install"
  exit(1)
end

if !File.exists?(".git")
  puts "No .git directory found."
  exit(1)
end

if File.exists?(".git/hooks/pre-commit")
  puts "Not overwriting existing hook: .git/hooks/pre-commit"
  exit(1)
end

if system("which rvm")
  cmd = "#{`which rvm`.chomp} default do ruby -rrubygems "
else
  cmd = "#{`which ruby`.chomp} -rrubygems "
end

cmd << '-e\"require \'pre-commit\';PreCommit.run\"'

File.open(".git/hooks/pre-commit","w") {|f| 
  f.write(template.gsub("%cmd%", cmd))
}

require 'fileutils'

FileUtils.chmod(0755, ".git/hooks/pre-commit")

puts "Installed hook: .git/hooks/pre-commit"
